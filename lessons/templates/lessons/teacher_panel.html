<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ü–∞–Ω–µ–ª—å –£—á–∏—Ç–µ–ª—è</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header {
      background: white;
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      margin-bottom: 30px;
    }

    .header h1 {
      color: #667eea;
      font-size: 2.5rem;
      margin-bottom: 10px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }

    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 15px;
      text-align: center;
    }

    .stat-card h3 {
      font-size: 2rem;
      margin-bottom: 5px;
    }

    .stat-card p {
      opacity: 0.9;
      font-size: 0.9rem;
    }

    .section {
      background: white;
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      margin-bottom: 30px;
    }

    .section h2 {
      color: #667eea;
      font-size: 1.8rem;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 3px solid #667eea;
    }

    .upload-area {
      border: 3px dashed #667eea;
      border-radius: 15px;
      padding: 40px;
      text-align: center;
      background: #f8f9ff;
      cursor: pointer;
      transition: all 0.3s;
      margin-bottom: 20px;
    }

    .upload-area:hover {
      background: #eef0ff;
      transform: translateY(-2px);
    }

    .upload-area.dragover {
      background: #e0e5ff;
      border-color: #764ba2;
    }

    .upload-icon {
      font-size: 4rem;
      margin-bottom: 10px;
    }

    .btn {
      padding: 12px 30px;
      border: none;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      margin: 5px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-success {
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      color: white;
    }

    .btn-danger {
      background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
      color: white;
    }

    .video-table, .lesson-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    .video-table th, .lesson-table th {
      background: #667eea;
      color: white;
      padding: 15px;
      text-align: left;
      font-weight: 600;
    }

    .video-table td, .lesson-table td {
      padding: 12px 15px;
      border-bottom: 1px solid #eee;
    }

    .video-table tr:hover, .lesson-table tr:hover {
      background: #f8f9ff;
    }

    .status-badge {
      display: inline-block;
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .status-pending {
      background: #ffd93d;
      color: #856404;
    }

    .status-processing {
      background: #6bcfff;
      color: #004085;
    }

    .status-done {
      background: #6ef3d6;
      color: #155724;
    }

    .status-error {
      background: #ff6b9d;
      color: #721c24;
    }

    .progress-container {
      margin: 20px 0;
      background: #eee;
      border-radius: 10px;
      overflow: hidden;
      height: 30px;
      display: none;
    }

    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      transition: width 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
    }

    .log-container {
      background: #1e1e1e;
      color: #00ff00;
      padding: 20px;
      border-radius: 10px;
      max-height: 300px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 0.85rem;
      display: none;
      margin-top: 20px;
    }

    .log-entry {
      margin-bottom: 5px;
    }

    input[type="file"] {
      display: none;
    }

    .back-link {
      display: inline-block;
      padding: 10px 20px;
      background: white;
      color: #667eea;
      text-decoration: none;
      border-radius: 10px;
      font-weight: 600;
      margin-bottom: 20px;
      transition: all 0.3s;
    }

    .back-link:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }
  </style>
</head>
<body>
  <div class="container">
    <a href="{% url 'home_uchi' %}" class="back-link">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —É—Ä–æ–∫–∞–º</a>

    <div class="header">
      <h1>üéì –ü–∞–Ω–µ–ª—å –£—á–∏—Ç–µ–ª—è</h1>
      <p>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∏–¥–µ–æ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ —É—Ä–æ–∫–æ–≤</p>
      
      <div class="stats-grid">
        <div class="stat-card">
          <h3>{{ total_videos }}</h3>
          <p>–í—Å–µ–≥–æ –≤–∏–¥–µ–æ</p>
        </div>
        <div class="stat-card">
          <h3>{{ pending_videos }}</h3>
          <p>–û–∂–∏–¥–∞—é—Ç</p>
        </div>
        <div class="stat-card">
          <h3>{{ processing_videos }}</h3>
          <p>–û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è</p>
        </div>
        <div class="stat-card">
          <h3>{{ done_videos }}</h3>
          <p>–ì–æ—Ç–æ–≤–æ</p>
        </div>
        <div class="stat-card">
          <h3>{{ error_videos }}</h3>
          <p>–û—à–∏–±–∫–∏</p>
        </div>
      </div>
    </div>

    <div class="section">
      <h2>üì§ –ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ</h2>
      <div class="upload-area" id="uploadArea">
        <div class="upload-icon">üìπ</div>
        <h3>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –≤–∏–¥–µ–æ —Å—é–¥–∞ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞</h3>
        <p>–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ñ–æ—Ä–º–∞—Ç—ã: MP4, MOV, AVI</p>
        <input type="file" id="fileInput" accept="video/*" multiple>
      </div>
      <div class="progress-container" id="progressContainer">
        <div class="progress-bar" id="progressBar">0%</div>
      </div>
      <div style="text-align: center;">
        <button class="btn btn-success" onclick="processAllVideos()">
          ‚ñ∂Ô∏è –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –≤—Å–µ –≤–∏–¥–µ–æ
        </button>
        <button class="btn btn-danger" onclick="recreateAllLessons()">
          üîÑ –ü–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å –≤—Å–µ —É—Ä–æ–∫–∏
        </button>
        <button class="btn btn-warning" onclick="resetStuckVideos()" style="background: #ff9800; color: white;">
          üîß –°–±—Ä–æ—Å–∏—Ç—å –∑–∞—Å—Ç—Ä—è–≤—à–∏–µ –≤–∏–¥–µ–æ
        </button>
      </div>
      <div class="log-container" id="logContainer"></div>
    </div>

    <div class="section">
      <h2>üìπ –í–∏–¥–µ–æ —Ñ–∞–π–ª—ã ({{ videos.count }})</h2>
      <table class="video-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
            <th>–°—Ç–∞—Ç—É—Å</th>
            <th>–ü—Ä–æ–≥—Ä–µ—Å—Å</th>
            <th>–í—Ä–µ–º—è</th>
            <th>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</th>
            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
          </tr>
        </thead>
        <tbody>
          {% for video in videos %}
          <tr data-video-id="{{ video.id }}">
            <td>{{ video.id }}</td>
            <td>{{ video.file_name }}</td>
            <td>
              <span class="status-badge status-{{ video.status }} status-cell">
                {{ video.status }}
              </span>
            </td>
            <td class="progress-cell" style="min-width: 200px;">
              {% if video.status == 'processing' %}
              <div style="display: flex; align-items: center; gap: 10px;">
                <div style="flex: 1; background: #e0e0e0; border-radius: 10px; height: 20px; overflow: hidden; position: relative;">
                  <div class="video-progress-bar" style="background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); height: 100%; width: 0%; transition: width 0.3s; border-radius: 10px;"></div>
                </div>
                <span class="progress-percent" style="font-size: 0.85rem; font-weight: 600; color: #667eea; min-width: 45px;">0%</span>
              </div>
              <div class="message-cell" style="font-size: 0.75rem; color: #667eea; margin-top: 5px;">
                {% if video.processing_message %}
                  {{ video.processing_message }}
                {% endif %}
              </div>
              {% else %}
              <div class="message-cell" style="font-size: 0.85rem; color: #667eea;">
                {% if video.processing_message %}
                  {{ video.processing_message }}
                {% endif %}
              </div>
              {% endif %}
            </td>
            <td class="time-cell" style="font-size: 0.85rem; color: #666;">
              {% if video.status == 'processing' %}
                <span class="time-remaining">–†–∞—Å—á–µ—Ç...</span>
              {% else %}
                -
              {% endif %}
            </td>
            <td>{{ video.created_at|date:"d.m.Y H:i" }}</td>
            <td>
              {% if video.status != 'processing' %}
              <button class="btn btn-primary" onclick="processVideo({{ video.id }})">
                –û–±—Ä–∞–±–æ—Ç–∞—Ç—å
              </button>
              {% endif %}
              {% if video.status == 'done' %}
              <button class="btn btn-success" onclick="processVideo({{ video.id }}, true)">
                –ü–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å
              </button>
              {% endif %}
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="7" style="text-align: center; padding: 40px;">
              –ù–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –≤–∏–¥–µ–æ
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="section">
      <h2>üìö –°–æ–∑–¥–∞–Ω–Ω—ã–µ —É—Ä–æ–∫–∏ ({{ lessons.count }})</h2>
      <table class="lesson-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
            <th>–ö–∞—Ä—Ç–æ—á–µ–∫</th>
            <th>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</th>
            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
          </tr>
        </thead>
        <tbody>
          {% for lesson in lessons %}
          <tr>
            <td>{{ lesson.id }}</td>
            <td>{{ lesson.title }}</td>
            <td>{{ lesson.cards.count }}</td>
            <td>{{ lesson.created_at|date:"d.m.Y H:i" }}</td>
            <td>
              <a href="{% url 'view_lesson_topics' lesson.id %}" class="btn btn-primary">
                –û—Ç–∫—Ä—ã—Ç—å
              </a>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="5" style="text-align: center; padding: 40px;">
              –ù–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —É—Ä–æ–∫–æ–≤
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <script>
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const progressContainer = document.getElementById('progressContainer');
    const progressBar = document.getElementById('progressBar');
    const logContainer = document.getElementById('logContainer');
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –¥–ª—è –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—â–∏—Ö—Å—è –≤–∏–¥–µ–æ
    const processingVideoIntervals = new Map();
    const timeUpdateIntervals = new Map(); // –¢–∞–π–º–µ—Ä—ã –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏
    function formatTime(seconds) {
      if (seconds < 60) {
        return `${seconds} —Å–µ–∫`;
      } else if (seconds < 3600) {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins} –º–∏–Ω ${secs} —Å–µ–∫`;
      } else {
        const hours = Math.floor(seconds / 3600);
        const mins = Math.floor((seconds % 3600) / 60);
        return `${hours} —á ${mins} –º–∏–Ω`;
      }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –≤–∏–¥–µ–æ –≤ —Ç–∞–±–ª–∏—Ü–µ
    async function updateVideoStatus(videoId) {
      try {
        const response = await fetch(`/api/videos/${videoId}/status/`);
        if (!response.ok) return;
        
        const statusData = await response.json();
        const row = document.querySelector(`tr[data-video-id="${videoId}"]`);
        if (!row) return;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ —Ç–∞–±–ª–∏—Ü–µ
        const statusCell = row.querySelector('.status-cell');
        if (statusCell) {
          statusCell.textContent = statusData.status;
          statusCell.className = `status-cell status-${statusData.status}`;
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
        if (statusData.status === 'processing') {
          const progressBar = row.querySelector('.video-progress-bar');
          const progressPercent = row.querySelector('.progress-percent');
          const timeRemaining = row.querySelector('.time-cell .time-remaining');
          
          if (progressBar && statusData.progress_percent !== undefined) {
            progressBar.style.width = statusData.progress_percent + '%';
          }
          
          if (progressPercent && statusData.progress_percent !== undefined) {
            progressPercent.textContent = statusData.progress_percent + '%';
          }
          
          if (timeRemaining) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ —Å —Å–µ—Ä–≤–µ—Ä–∞
            if (statusData.estimated_seconds_remaining !== undefined && statusData.estimated_seconds_remaining > 0) {
              timeRemaining.dataset.remaining = statusData.estimated_seconds_remaining;
            }
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
            if (!timeUpdateIntervals.has(videoId)) {
              const timeInterval = setInterval(() => {
                const timeEl = row.querySelector('.time-cell .time-remaining');
                if (timeEl && timeEl.dataset.remaining !== undefined) {
                  let remaining = parseInt(timeEl.dataset.remaining);
                  if (remaining > 0) {
                    remaining--;
                    timeEl.dataset.remaining = remaining;
                    timeEl.textContent = `–û—Å—Ç–∞–ª–æ—Å—å: ${formatTime(remaining)}`;
                  } else {
                    timeEl.textContent = '–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ...';
                    clearInterval(timeInterval);
                    timeUpdateIntervals.delete(videoId);
                  }
                }
              }, 1000);
              timeUpdateIntervals.set(videoId, timeInterval);
              
              // –ü–µ—Ä–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
              const initialRemaining = timeRemaining.dataset.remaining ? parseInt(timeRemaining.dataset.remaining) : (statusData.estimated_seconds_remaining || 0);
              if (initialRemaining > 0) {
                timeRemaining.textContent = `–û—Å—Ç–∞–ª–æ—Å—å: ${formatTime(initialRemaining)}`;
              }
            }
          }
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ø—Ä–æ–≥—Ä–µ—Å—Å–µ
        const messageCell = row.querySelector('.message-cell');
        if (messageCell) {
          if (statusData.processing_message) {
            messageCell.textContent = statusData.processing_message;
            messageCell.style.display = '';
          } else {
            messageCell.style.display = 'none';
          }
        }
        
        // –ï—Å–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞, –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º polling –∏ —Ç–∞–π–º–µ—Ä –≤—Ä–µ–º–µ–Ω–∏
        if (statusData.status === 'done' || statusData.status === 'error') {
          if (processingVideoIntervals.has(videoId)) {
            clearInterval(processingVideoIntervals.get(videoId));
            processingVideoIntervals.delete(videoId);
          }
          if (timeUpdateIntervals.has(videoId)) {
            clearInterval(timeUpdateIntervals.get(videoId));
            timeUpdateIntervals.delete(videoId);
          }
          // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
          setTimeout(() => location.reload(), 2000);
        }
      } catch (error) {
        console.error(`–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –≤–∏–¥–µ–æ ${videoId}:`, error);
      }
    }
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—â–∏—Ö—Å—è –≤–∏–¥–µ–æ
    function startAutoTracking() {
      const processingRows = document.querySelectorAll('tr[data-video-id]');
      processingRows.forEach(row => {
        const videoId = row.getAttribute('data-video-id');
        const statusCell = row.querySelector('.status-cell');
        if (statusCell && statusCell.textContent.trim() === 'processing') {
          // –°–æ–∑–¥–∞–µ–º —è—á–µ–π–∫—É –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π, –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
          let messageCell = row.querySelector('.message-cell');
          if (!messageCell) {
            messageCell = document.createElement('td');
            messageCell.className = 'message-cell';
            messageCell.style.fontSize = '0.85rem';
            messageCell.style.color = '#667eea';
            row.appendChild(messageCell);
          }
          
          // –ù–∞—á–∏–Ω–∞–µ–º polling
          updateVideoStatus(videoId);
          const interval = setInterval(() => updateVideoStatus(videoId), 2000);
          processingVideoIntervals.set(videoId, interval);
        }
      });
    }
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', startAutoTracking);
    } else {
      startAutoTracking();
    }

    // Drag and drop
    uploadArea.addEventListener('click', () => fileInput.click());

    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      const files = e.dataTransfer.files;
      handleFiles(files);
    });

    fileInput.addEventListener('change', (e) => {
      handleFiles(e.target.files);
    });

    async function handleFiles(files) {
      if (files.length === 0) return;

      const formData = new FormData();
      let totalSize = 0;
      for (let file of files) {
        formData.append('videos', file);
        totalSize += file.size;
      }

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
      progressContainer.style.display = 'block';
      progressBar.style.width = '0%';
      progressBar.textContent = '0%';
      
      // #region agent log
      fetch('http://127.0.0.1:7244/ingest/47fa6f77-db98-4c70-bd7a-f564ec61d812',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'teacher_panel.html:416',message:'Starting file upload',data:{filesCount:files.length,totalSize,fileNames:Array.from(files).map(f=>f.name)},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{});
      // #endregion
      
      try {
        const xhr = new XMLHttpRequest();
        
        // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –∑–∞–≥—Ä—É–∑–∫–∏
        xhr.upload.addEventListener('progress', (e) => {
          if (e.lengthComputable) {
            const percentComplete = (e.loaded / e.total) * 100;
            progressBar.style.width = percentComplete + '%';
            progressBar.textContent = Math.round(percentComplete) + '%';
          }
        });
        
        xhr.addEventListener('load', () => {
          if (xhr.status === 200) {
            try {
              const data = JSON.parse(xhr.responseText);
              // #region agent log
              fetch('http://127.0.0.1:7244/ingest/47fa6f77-db98-4c70-bd7a-f564ec61d812',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'teacher_panel.html:445',message:'Upload completed',data:{success:data.success,message:data.message,files:data.files},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'B'})}).catch(()=>{});
              // #endregion
              if (data.success) {
                progressBar.style.width = '100%';
                progressBar.textContent = '100%';
                alert(`‚úÖ ${data.message}`);
                location.reload();
              } else {
                progressBar.textContent = '–û—à–∏–±–∫–∞';
                alert(`‚ùå –û—à–∏–±–∫–∞: ${data.error}`);
              }
            } catch (e) {
              progressBar.textContent = '–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞';
              alert(`‚ùå –û—à–∏–±–∫–∞: ${e.message}`);
            }
          } else {
            progressBar.textContent = '–û—à–∏–±–∫–∞ ' + xhr.status;
            alert(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${xhr.status} ${xhr.statusText}`);
          }
        });
        
        xhr.addEventListener('error', () => {
          // #region agent log
          fetch('http://127.0.0.1:7244/ingest/47fa6f77-db98-4c70-bd7a-f564ec61d812',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'teacher_panel.html:465',message:'Upload error',data:{status:xhr.status,statusText:xhr.statusText},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'C'})}).catch(()=>{});
          // #endregion
          progressBar.textContent = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏';
          alert(`‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ`);
        });
        
        xhr.open('POST', '/api/videos/upload/');
        xhr.send(formData);
        
      } catch (error) {
        // #region agent log
        fetch('http://127.0.0.1:7244/ingest/47fa6f77-db98-4c70-bd7a-f564ec61d812',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'teacher_panel.html:475',message:'Upload exception',data:{error:error.message},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'D'})}).catch(()=>{});
        // #endregion
        progressBar.textContent = '–û—à–∏–±–∫–∞';
        alert(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}`);
      }
    }

    async function processVideo(videoId, forceRecreate = false) {
      // #region agent log
      fetch('http://127.0.0.1:7244/ingest/47fa6f77-db98-4c70-bd7a-f564ec61d812',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'teacher_panel.html:454',message:'processVideo called',data:{videoId,forceRecreate},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'E'})}).catch(()=>{});
      // #endregion
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
      progressContainer.style.display = 'block';
      progressBar.style.width = '0%';
      progressBar.textContent = '–ù–∞—á–∏–Ω–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É...';
      logContainer.style.display = 'block';
      logContainer.innerHTML = '<div class="log-entry">üîÑ –ù–∞—á–∏–Ω–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –≤–∏–¥–µ–æ...</div>';
      
      let pollInterval = null;
      let isProcessing = false;
      
      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
      const updateStatus = async () => {
        try {
          const statusResponse = await fetch(`/api/videos/${videoId}/status/`);
          if (!statusResponse.ok) return;
          
          const statusData = await statusResponse.json();
          
          // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –∏ –ª–æ–≥–∏
          if (statusData.processing_message) {
            progressBar.textContent = statusData.processing_message;
            const lastLog = logContainer.querySelector('.log-entry:last-child');
            if (!lastLog || !lastLog.textContent.includes(statusData.processing_message)) {
              logContainer.innerHTML += `<div class="log-entry">üìπ ${statusData.processing_message}</div>`;
              logContainer.scrollTop = logContainer.scrollHeight;
            }
          }
          
          // –û–±–Ω–æ–≤–ª—è–µ–º —à–∏—Ä–∏–Ω—É –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç–∞—Ç—É—Å–∞
          if (statusData.processing_status === 'transcribing') {
            progressBar.style.width = '30%';
          } else if (statusData.processing_status === 'generating_lesson') {
            progressBar.style.width = '60%';
          } else if (statusData.status === 'done') {
            progressBar.style.width = '100%';
            progressBar.textContent = '100% - –ì–æ—Ç–æ–≤–æ!';
            if (pollInterval) {
              clearInterval(pollInterval);
              pollInterval = null;
            }
            logContainer.innerHTML += '<div class="log-entry success">‚úÖ –í–∏–¥–µ–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ —É—Å–ø–µ—à–Ω–æ!</div>';
            if (statusData.lesson_title) {
              alert(`‚úÖ –í–∏–¥–µ–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ —É—Å–ø–µ—à–Ω–æ! –£—Ä–æ–∫: ${statusData.lesson_title}`);
            }
            setTimeout(() => location.reload(), 2000);
            return;
          } else if (statusData.status === 'error') {
            progressBar.style.width = '0%';
            progressBar.textContent = '–û—à–∏–±–∫–∞';
            if (pollInterval) {
              clearInterval(pollInterval);
              pollInterval = null;
            }
            logContainer.innerHTML += `<div class="log-entry error">‚ùå –û—à–∏–±–∫–∞: ${statusData.error_message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}</div>`;
            alert(`‚ùå –û—à–∏–±–∫–∞: ${statusData.error_message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
            return;
          }
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞:', error);
        }
      };
      
      try {
        progressBar.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞...';
        const response = await fetch(`/api/videos/${videoId}/process/`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ force_recreate: forceRecreate })
        });
        
        // #region agent log
        fetch('http://127.0.0.1:7244/ingest/47fa6f77-db98-4c70-bd7a-f564ec61d812',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'teacher_panel.html:470',message:'processVideo response received',data:{status:response.status,ok:response.ok},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'F'})}).catch(()=>{});
        // #endregion
        
        if (!response.ok) {
          const errorData = await response.json();
          progressBar.textContent = '–û—à–∏–±–∫–∞';
          logContainer.innerHTML += `<div class="log-entry error">‚ùå –û—à–∏–±–∫–∞: ${errorData.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}</div>`;
          alert(`‚ùå –û—à–∏–±–∫–∞: ${errorData.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
          return;
        }
        
        progressBar.textContent = '–û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞—á–∞—Ç–∞...';
        logContainer.innerHTML += '<div class="log-entry">‚úÖ –ó–∞–ø—Ä–æ—Å –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω</div>';
        
        // –ù–∞—á–∏–Ω–∞–µ–º polling —Å—Ç–∞—Ç—É—Å–∞ –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã
        isProcessing = true;
        pollInterval = setInterval(updateStatus, 2000);
        // –ü–µ—Ä–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ä–∞–∑—É
        updateStatus();
        
      } catch (error) {
        // #region agent log
        fetch('http://127.0.0.1:7244/ingest/47fa6f77-db98-4c70-bd7a-f564ec61d812',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'teacher_panel.html:490',message:'processVideo exception',data:{error:error.message,stack:error.stack},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'H'})}).catch(()=>{});
        // #endregion
        progressBar.textContent = '–û—à–∏–±–∫–∞';
        logContainer.innerHTML += `<div class="log-entry error">‚ùå –ò—Å–∫–ª—é—á–µ–Ω–∏–µ: ${error.message}</div>`;
        alert(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`);
        if (pollInterval) {
          clearInterval(pollInterval);
        }
      }
    }

    async function processAllVideos() {
      if (!confirm('–û–±—Ä–∞–±–æ—Ç–∞—Ç—å –≤—Å–µ –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –≤–∏–¥–µ–æ?')) return;

      progressContainer.style.display = 'block';
      logContainer.style.display = 'block';
      logContainer.innerHTML = '<div class="log-entry">–ù–∞—á–∏–Ω–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –≤—Å–µ—Ö –≤–∏–¥–µ–æ...</div>';

      try {
        const response = await fetch('/api/videos/process_all/', {
          method: 'POST'
        });
        const data = await response.json();
        
        logContainer.innerHTML += `<div class="log-entry">‚úÖ –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ ${data.processed_count} –∏–∑ ${data.total_count} –≤–∏–¥–µ–æ</div>`;
        
        if (data.errors && data.errors.length > 0) {
          logContainer.innerHTML += '<div class="log-entry">‚ùå –û—à–∏–±–∫–∏:</div>';
          data.errors.forEach(err => {
            logContainer.innerHTML += `<div class="log-entry">  - ${err.file_name}: ${err.error}</div>`;
          });
        }

        progressBar.style.width = '100%';
        progressBar.textContent = '100%';
        
        setTimeout(() => location.reload(), 2000);
      } catch (error) {
        logContainer.innerHTML += `<div class="log-entry">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
      }
    }

    async function recreateAllLessons() {
      if (!confirm('–í–ù–ò–ú–ê–ù–ò–ï! –≠—Ç–æ —É–¥–∞–ª–∏—Ç –≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —É—Ä–æ–∫–∏ –∏ —Å–æ–∑–¥–∞—Å—Ç –∏—Ö –∑–∞–Ω–æ–≤–æ. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')) return;

      progressContainer.style.display = 'block';
      logContainer.style.display = 'block';
      logContainer.innerHTML = '<div class="log-entry">–ü–µ—Ä–µ—Å–æ–∑–¥–∞—ë–º –≤—Å–µ —É—Ä–æ–∫–∏...</div>';

      try {
        const response = await fetch('/api/videos/recreate_all_lessons/', {
          method: 'POST'
        });
        const data = await response.json();
        
        logContainer.innerHTML += `<div class="log-entry">üóëÔ∏è –£–¥–∞–ª–µ–Ω–æ ${data.deleted_lessons} —É—Ä–æ–∫–æ–≤</div>`;
        logContainer.innerHTML += `<div class="log-entry">‚úÖ –°–æ–∑–¥–∞–Ω–æ ${data.processed_count} –∏–∑ ${data.total_count} —É—Ä–æ–∫–æ–≤</div>`;
        
        if (data.errors && data.errors.length > 0) {
          logContainer.innerHTML += '<div class="log-entry">‚ùå –û—à–∏–±–∫–∏:</div>';
          data.errors.forEach(err => {
            logContainer.innerHTML += `<div class="log-entry">  - ${err.file_name}: ${err.error}</div>`;
          });
        }

        progressBar.style.width = '100%';
        progressBar.textContent = '100%';
        
        setTimeout(() => location.reload(), 2000);
      } catch (error) {
        logContainer.innerHTML += `<div class="log-entry">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
      }
    }

    async function resetStuckVideos() {
      if (!confirm('–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –≤–∏–¥–µ–æ, –∫–æ—Ç–æ—Ä—ã–µ –∑–∞—Å—Ç—Ä—è–ª–∏ –≤ —Å—Ç–∞—Ç—É—Å–µ "processing" –±–æ–ª–µ–µ 2 —á–∞—Å–æ–≤?\n\n–í–∏–¥–µ–æ —Å –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ —Ñ–∞–π–ª–∞–º–∏ –±—É–¥—É—Ç –ø–æ–º–µ—á–µ–Ω—ã –∫–∞–∫ "error", –æ—Å—Ç–∞–ª—å–Ω—ã–µ –≤–µ—Ä–Ω—É—Ç—Å—è –≤ —Å—Ç–∞—Ç—É—Å "pending".')) return;

      progressContainer.style.display = 'block';
      logContainer.style.display = 'block';
      logContainer.innerHTML = '<div class="log-entry">üîß –°–±—Ä–æ—Å –∑–∞—Å—Ç—Ä—è–≤—à–∏—Ö –≤–∏–¥–µ–æ...</div>';

      try {
        const formData = new FormData();
        formData.append('hours', '2');
        
        const response = await fetch('/api/videos/reset_stuck/', {
          method: 'POST',
          body: formData
        });
        const data = await response.json();
        
        if (data.success) {
          logContainer.innerHTML += `<div class="log-entry success">‚úÖ ${data.message}</div>`;
          if (data.errors && data.errors.length > 0) {
            logContainer.innerHTML += '<div class="log-entry">‚ùå –û—à–∏–±–∫–∏ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ:</div>';
            data.errors.forEach(err => {
              logContainer.innerHTML += `<div class="log-entry">  - ID ${err.video_id}: ${err.error}</div>`;
            });
          }
          progressBar.style.width = '100%';
          progressBar.textContent = '100%';
          setTimeout(() => location.reload(), 2000);
        } else {
          logContainer.innerHTML += `<div class="log-entry error">‚ùå –û—à–∏–±–∫–∞: ${data.error}</div>`;
        }
      } catch (error) {
        logContainer.innerHTML += `<div class="log-entry error">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
      }
    }
  </script>
</body>
</html>

