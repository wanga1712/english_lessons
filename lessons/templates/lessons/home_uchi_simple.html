<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ö–∞—Ä—Ç–∞ –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏–π</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      overflow-x: auto;
    }

    .teacher-button {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 30px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 15px;
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
      text-decoration: none;
      display: inline-block;
      z-index: 1000;
    }

    .map-wrapper {
      max-width: 1400px;
      margin: 0 auto;
      position: relative;
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      min-height: 600px;
    }

    .map-header {
      text-align: center;
      margin-bottom: 30px;
    }

    .map-header h1 {
      color: #667eea;
      font-size: 2.5rem;
      margin-bottom: 10px;
    }

    .adventure-map {
      position: relative;
      width: 100%;
      min-height: 500px;
      background: 
        linear-gradient(135deg, #e0f7fa 0%, #fff9c4 50%, #f3e5f5 100%),
        url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200"><defs><pattern id="grid" width="20" height="20" patternUnits="userSpaceOnUse"><path d="M 20 0 L 0 0 0 20" fill="none" stroke="%23ddd" stroke-width="0.5"/></pattern></defs><rect width="100%25" height="100%25" fill="url(%23grid)"/></svg>');
      background-size: cover, 20px 20px;
      border-radius: 15px;
      padding: 40px;
      border: 3px solid #8b4513;
      box-shadow: inset 0 0 30px rgba(0,0,0,0.1);
    }

    .lesson-point {
      position: absolute;
      width: 60px;
      height: 60px;
      cursor: pointer;
      transition: all 0.3s ease;
      z-index: 10;
    }

    .lesson-point:hover {
      transform: scale(1.3);
      z-index: 20;
    }

    .point-circle {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.8rem;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      border: 3px solid white;
    }

    .point-available {
      background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
      animation: pulse 2s ease-in-out infinite;
    }

    .point-completed {
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
    }

    .point-current {
      background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
      animation: glow 1.5s ease-in-out infinite;
    }

    .point-locked {
      background: linear-gradient(135deg, #9E9E9E 0%, #757575 100%);
      opacity: 0.6;
      cursor: not-allowed;
    }

    .point-number {
      position: absolute;
      bottom: -25px;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      padding: 3px 10px;
      border-radius: 10px;
      font-weight: bold;
      font-size: 0.75rem;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      white-space: nowrap;
    }

    .path-line {
      position: absolute;
      height: 4px;
      background: #8b4513;
      border-radius: 2px;
      z-index: 1;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .stats-panel {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 15px;
      text-align: center;
    }

    .stat-card h3 {
      font-size: 2rem;
      margin-bottom: 5px;
    }

    .achievements-panel {
      position: fixed;
      top: 100px;
      left: 20px;
      background: white;
      padding: 20px;
      border-radius: 20px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.15);
      max-width: 250px;
      z-index: 1000;
    }

    .achievement-badge {
      display: inline-block;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
      margin: 5px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      cursor: pointer;
    }

    .achievement-locked {
      background: linear-gradient(135deg, #E0E0E0 0%, #BDBDBD 100%);
      opacity: 0.5;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    @keyframes glow {
      0%, 100% { box-shadow: 0 0 15px rgba(33, 150, 243, 0.6); }
      50% { box-shadow: 0 0 30px rgba(33, 150, 243, 1); }
    }

    .error-box {
      background: #ffebee;
      color: #c62828;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
      display: none;
    }
  </style>
</head>
<body>
  <a href="/teacher/" class="teacher-button">üë®‚Äçüè´ –ü–∞–Ω–µ–ª—å —É—á–∏—Ç–µ–ª—è</a>

  <div class="achievements-panel">
    <h3 style="margin-bottom: 15px; color: #667eea; font-size: 1.1rem;">üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</h3>
    <div id="achievementsList">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
  </div>

  <div class="map-wrapper">
    <div class="map-header">
      <h1>üó∫Ô∏è –ö–∞—Ä—Ç–∞ –ü—Ä–∏–∫–ª—é—á–µ–Ω–∏–π</h1>
      <p style="color: #666;">–í—ã–±–µ—Ä–∏—Ç–µ —É—Ä–æ–∫ –∏ –Ω–∞—á–Ω–∏—Ç–µ –æ–±—É—á–µ–Ω–∏–µ!</p>
    </div>

    <div class="error-box" id="errorBox"></div>

    <div class="stats-panel">
      <div class="stat-card">
        <h3 id="totalLessons">0</h3>
        <p>–í—Å–µ–≥–æ —É—Ä–æ–∫–æ–≤</p>
      </div>
      <div class="stat-card">
        <h3 id="completedLessons">0</h3>
        <p>–ü—Ä–æ–π–¥–µ–Ω–æ</p>
      </div>
      <div class="stat-card">
        <h3 id="userScore">0</h3>
        <p>‚≠ê –ë–∞–ª–ª–æ–≤</p>
      </div>
      <div class="stat-card">
        <h3 id="currentLevel">1</h3>
        <p>–£—Ä–æ–≤–µ–Ω—å</p>
      </div>
    </div>

    <div class="adventure-map" id="adventureMap">
      <div id="lessonPoints"></div>
    </div>
  </div>

  <script>
    console.log('=== SCRIPT LOADED ===');
    
    const LESSONS_PER_LEVEL = 25;
    let lessons = [];
    let completedLessons = new Set();
    
    // Parse avatar data - simple and safe
    let avatarData = {name: '–£—á–µ–Ω–∏–∫', emoji: 'üéì', score: 0.0};
    {% if avatar_data_json %}
    try {
      avatarData = JSON.parse('{{ avatar_data_json|escapejs }}');
    } catch(e) {
      console.warn('Could not parse avatar data, using default:', e);
    }
    {% endif %}
    console.log('Avatar data:', avatarData);

    // Simple grid positions for lessons
    const positions = [
      {x: 10, y: 20}, {x: 25, y: 15}, {x: 40, y: 25}, {x: 55, y: 18}, {x: 70, y: 22},
      {x: 85, y: 16}, {x: 90, y: 30}, {x: 75, y: 35}, {x: 60, y: 32}, {x: 45, y: 38},
      {x: 30, y: 40}, {x: 15, y: 45}, {x: 20, y: 55}, {x: 35, y: 50}, {x: 50, y: 55},
      {x: 65, y: 52}, {x: 80, y: 58}, {x: 85, y: 70}, {x: 70, y: 75}, {x: 55, y: 72},
      {x: 40, y: 78}, {x: 25, y: 75}, {x: 15, y: 80}, {x: 30, y: 85}, {x: 50, y: 88}
    ];

    async function loadLessons() {
      console.log('=== LOADING LESSONS ===');
      const errorBox = document.getElementById('errorBox');
      const achievementsList = document.getElementById('achievementsList');
      
      try {
        console.log('Fetching from /api/lessons/');
        const response = await fetch('/api/lessons/');
        console.log('Response status:', response.status);
        console.log('Response ok:', response.ok);
        console.log('Response headers:', response.headers);
        
        if (!response.ok) {
          const errorText = await response.text();
          console.error('Response error text:', errorText);
          throw new Error('HTTP ' + response.status + ': ' + errorText);
        }
        
        const data = await response.json();
        console.log('=== DATA RECEIVED ===');
        console.log('Full data object:', data);
        console.log('Data keys:', Object.keys(data));
        console.log('Has lessons property:', 'lessons' in data);
        console.log('Lessons value:', data.lessons);
        console.log('Lessons type:', typeof data.lessons);
        console.log('Lessons is array:', Array.isArray(data.lessons));
        
        lessons = data.lessons || [];
        console.log('=== LESSONS ARRAY ===');
        console.log('Lessons count:', lessons.length);
        console.log('Lessons array:', lessons);
        
        if (lessons.length > 0) {
          console.log('First lesson:', lessons[0]);
        }
        
        // Find completed lessons
        lessons.forEach(lesson => {
          if (lesson.user_completed) {
            completedLessons.add(lesson.id);
          }
        });
        
        console.log('Completed lessons:', completedLessons.size);
        
        if (lessons.length === 0) {
          console.warn('‚ö†Ô∏è No lessons found in response!');
          console.log('Response data was:', data);
          showError('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —É—Ä–æ–∫–æ–≤. –ó–∞–≥—Ä—É–∑–∏—Ç–µ –≤–∏–¥–µ–æ –≤ –ø–∞–Ω–µ–ª–∏ —É—á–∏—Ç–µ–ª—è.');
          if (achievementsList) {
            achievementsList.innerHTML = '<div style="color: #999;">–ù–µ—Ç –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π</div>';
          }
        } else {
          console.log('‚úÖ SUCCESS! Found', lessons.length, 'lessons');
          console.log('=== CALLING RENDER FUNCTIONS ===');
          
          try {
            console.log('1. Calling renderMap()...');
            renderMap();
            console.log('   ‚úì renderMap() completed');
          } catch(e) {
            console.error('   ‚úó renderMap() failed:', e);
          }
          
          try {
            console.log('2. Calling updateStats()...');
            updateStats();
            console.log('   ‚úì updateStats() completed');
          } catch(e) {
            console.error('   ‚úó updateStats() failed:', e);
          }
          
          try {
            console.log('3. Calling loadAchievements()...');
            loadAchievements();
            console.log('   ‚úì loadAchievements() completed');
          } catch(e) {
            console.error('   ‚úó loadAchievements() failed:', e);
          }
          
          console.log('‚úÖ All functions called');
        }
      } catch (error) {
        console.error('Error:', error);
        showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + error.message);
        if (achievementsList) {
          achievementsList.innerHTML = '<div style="color: #c62828;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
        }
      }
    }

    function showError(message) {
      const errorBox = document.getElementById('errorBox');
      if (errorBox) {
        errorBox.textContent = message;
        errorBox.style.display = 'block';
      }
      console.error('Error:', message);
    }

    function renderMap() {
      console.log('=== RENDERING MAP ===');
      console.log('Lessons to render:', lessons.length);
      console.log('Lessons array:', lessons);
      
      const container = document.getElementById('lessonPoints');
      console.log('Container element:', container);
      
      if (!container) {
        console.error('ERROR: Container lessonPoints not found!');
        showError('–û—à–∏–±–∫–∞: –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–∞—Ä—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω');
        return;
      }
      
      console.log('Clearing container...');
      container.innerHTML = '';
      console.log('Container cleared');
      
      lessons.forEach((lesson, index) => {
        const pos = positions[index % positions.length];
        const isCompleted = completedLessons.has(lesson.id);
        const isAvailable = index === 0 || completedLessons.has(lessons[index - 1]?.id);
        const isCurrent = isAvailable && !isCompleted;
        const isLocked = !isAvailable && !isCompleted;
        
        let statusClass = 'point-locked';
        let emoji = '‚ùì';
        
        if (isCompleted) {
          statusClass = 'point-completed';
          emoji = '‚úÖ';
        } else if (isCurrent) {
          statusClass = 'point-current';
          emoji = 'üéØ';
        } else if (isAvailable) {
          statusClass = 'point-available';
          emoji = 'üìö';
        }
        
        const point = document.createElement('div');
        point.className = 'lesson-point';
        point.style.left = pos.x + '%';
        point.style.top = pos.y + '%';
        point.style.transform = 'translate(-50%, -50%)';
        
        point.innerHTML = `
          <div class="point-circle ${statusClass}">${emoji}</div>
          <div class="point-number">${index + 1}</div>
        `;
        
        if (!isLocked) {
          point.onclick = () => {
            window.location.href = '/lesson/' + lesson.id + '/uchi/';
          };
          point.title = lesson.title || '–£—Ä–æ–∫ ' + (index + 1);
        } else {
          point.title = '–ó–∞–≤–µ—Ä—à–∏—Ç–µ –ø—Ä–µ–¥—ã–¥—É—â–∏–π —É—Ä–æ–∫';
        }
        
        container.appendChild(point);
        console.log(`‚úì Point ${index + 1} added: lesson ${lesson.id} at (${pos.x}%, ${pos.y}%) - ${statusClass}`);
        
        // Draw line to previous point
        if (index > 0) {
          const prevPos = positions[(index - 1) % positions.length];
          const line = document.createElement('div');
          line.className = 'path-line';
          
          const x1 = prevPos.x;
          const y1 = prevPos.y;
          const x2 = pos.x;
          const y2 = pos.y;
          
          const length = Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
          const angle = Math.atan2(y2 - y1, x2 - x1) * 180 / Math.PI;
          
          line.style.width = length.toString() + '%';
          line.style.left = x1.toString() + '%';
          line.style.top = y1.toString() + '%';
          line.style.transform = 'rotate(' + angle.toString() + 'deg)';
          line.style.transformOrigin = '0 50%';
          if (isLocked) {
            line.style.background = '#ccc';
            line.style.opacity = '0.5';
          }
          
          container.appendChild(line);
        }
      });
      
      console.log('=== MAP RENDERING COMPLETE ===');
      console.log('Total points created:', lessons.length);
      console.log('Container children count:', container.children.length);
      console.log('Container HTML length:', container.innerHTML.length);
      
      if (container.children.length === 0) {
        console.error('‚ùå WARNING: No points were added to container!');
        console.error('Container innerHTML:', container.innerHTML.substring(0, 200));
      } else {
        console.log('‚úÖ Map rendered successfully!');
        console.log('First child:', container.children[0]);
      }
    }

    function updateStats() {
      const total = lessons.length;
      const completed = completedLessons.size;
      const level = Math.floor(completed / LESSONS_PER_LEVEL) + 1;
      
      const totalEl = document.getElementById('totalLessons');
      const completedEl = document.getElementById('completedLessons');
      const scoreEl = document.getElementById('userScore');
      const levelEl = document.getElementById('currentLevel');
      
      if (totalEl) totalEl.textContent = total;
      if (completedEl) completedEl.textContent = completed;
      if (scoreEl) scoreEl.textContent = Math.round(avatarData.score || 0);
      if (levelEl) levelEl.textContent = level;
    }

    function loadAchievements() {
      console.log('Loading achievements...');
      const achievementsList = document.getElementById('achievementsList');
      if (!achievementsList) {
        console.error('Achievements list not found!');
        return;
      }
      
      const achievements = [
        {emoji: 'üéâ', title: '–ü–µ—Ä–≤—ã–π —É—Ä–æ–∫', unlocked: completedLessons.size >= 1},
        {emoji: 'üåü', title: '5 —É—Ä–æ–∫–æ–≤', unlocked: completedLessons.size >= 5},
        {emoji: 'üèÜ', title: '10 —É—Ä–æ–∫–æ–≤', unlocked: completedLessons.size >= 10},
        {emoji: 'üéñÔ∏è', title: '–£—Ä–æ–≤–µ–Ω—å 1', unlocked: completedLessons.size >= 25},
        {emoji: 'üíé', title: '–ò–¥–µ–∞–ª—å–Ω–æ', unlocked: false},
        {emoji: 'üî•', title: '–ù–µ–¥–µ–ª—è –ø–æ–¥—Ä—è–¥', unlocked: false},
      ];
      
      achievementsList.innerHTML = achievements.map(ach => 
        '<div class="achievement-badge ' + (ach.unlocked ? '' : 'achievement-locked') + 
        '" title="' + ach.title + '">' + ach.emoji + '</div>'
      ).join('');
      
      console.log('Achievements rendered');
    }

    // Start loading when page is ready
    console.log('Starting initialization...');
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', loadLessons);
    } else {
      loadLessons();
    }
  </script>
</body>
</html>

